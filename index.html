<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulador Financeiro Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      /* Corrige cores de inputs no modo escuro */
      .dark input,
      .dark select,
      .dark textarea {
        background-color: #374151 !important;
        color: #f3f4f6 !important;
        border-color: #4b5563 !important;
      }

      .dark input::placeholder,
      .dark select::placeholder {
        color: #9ca3af !important;
      }

      /* Melhoria para opções do select no modo escuro */
      .dark select option {
        background-color: #374151;
        color: #f3f4f6;
      }

      /* Melhoria para hover nos selects */
      .dark select option:hover {
        background-color: #4b5563;
      }

      /* Melhoria para tabelas no modo escuro */
      .dark table {
        color: #f3f4f6;
      }

      .dark th {
        background-color: #1f2937;
      }

      .dark tr:nth-child(even) {
        background-color: #374151;
      }

      .dark tr:hover {
        background-color: #4b5563;
      }
    </style>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 max-w-6xl">
      <h1
        class="text-3xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400"
      >
        Simulador de Financiamento Imobiliário
      </h1>

      <!-- Painel de entrada -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">
          Dados do Financiamento
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1"
                >Valor do Imóvel (R$)</label
              >
              <input
                id="valorImovel"
                type="number"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Entrada (R$)</label>
              <input
                id="entrada"
                type="number"
                class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white"
                value="0"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1"
                >Taxa de Juros (% a.m.)</label
              >
              <input
                id="taxa"
                type="number"
                step="0.01"
                class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white"
                placeholder="Ex: 0.8"
              />
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <div>
                <label class="block text-sm font-medium mb-1"
                  >Prazo em Meses</label
                >
                <input
                  id="meses"
                  type="number"
                  min="1"
                  max="600"
                  value="120"
                  class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white"
                  placeholder="Digite o prazo em meses"
                />
              </div>

              <div class="flex items-center space-x-2">
                <span class="text-sm">ou selecione:</span>
                <button
                  type="button"
                  onclick="document.getElementById('meses').value = 120"
                  class="px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
                >
                  10 anos
                </button>
                <button
                  type="button"
                  onclick="document.getElementById('meses').value = 180"
                  class="px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
                >
                  15 anos
                </button>
                <button
                  type="button"
                  onclick="document.getElementById('meses').value = 240"
                  class="px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
                >
                  20 anos
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1"
                >Sistema de Amortização</label
              >
              <select
                id="sistema"
                class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white"
              >
                <option value="price">PRICE (Parcelas Fixas)</option>
                <option value="sac">SAC (Amortização Constante)</option>
              </select>
            </div>

            <button
              onclick="calcular()"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200 mt-2"
            >
              Simular Financiamento
            </button>
          </div>
        </div>
      </div>

      <!-- Painel de resumo -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mt-6">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">
          Resumo da Simulação
        </h2>
        <div id="resumo" class="space-y-4">
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            Preencha os dados e clique em "Simular Financiamento"
          </div>
        </div>
      </div>

      <!-- Simulação de Cenários -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mt-6">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">
          Simular Cenários
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium mb-1"
              >% de Antecipação</label
            >
            <input
              id="percentAntecipacao"
              type="number"
              min="0"
              max="100"
              value="10"
              class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1"
              >Mês para Antecipar</label
            >
            <input
              id="mesAntecipacao"
              type="number"
              min="1"
              value="12"
              class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div class="flex items-end">
            <button
              onclick="simularAntecipacao()"
              class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg w-full"
            >
              Simular Antecipação
            </button>
          </div>
        </div>

        <div
          id="resultadoAntecipacao"
          class="hidden bg-blue-50 dark:bg-blue-900 p-4 rounded-lg"
        >
          <h3 class="font-semibold mb-2">Resultado da Antecipação</h3>
          <div id="detalhesAntecipacao"></div>
        </div>
      </div>

      <!-- Resultados detalhados -->
      <div class="mt-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">
          Tabela de Amortização
        </h2>
        <div class="overflow-x-auto">
          <table id="tabelaResultados" class="w-full">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-3 text-left">Mês</th>
                <th class="p-3 text-left">Prestação</th>
                <th class="p-3 text-left">Juros</th>
                <th class="p-3 text-left">Amortização</th>
                <th class="p-3 text-left">Saldo Devedor</th>
              </tr>
            </thead>
            <tbody id="corpoTabela">
              <!-- Preenchido pelo JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-semibold mb-4 border-b pb-2">
            Evolução das Parcelas
          </h2>
          <canvas id="graficoParcelas" height="300"></canvas>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-semibold mb-4 border-b pb-2">
            Composição do Financiamento
          </h2>
          <canvas id="graficoComposicao" height="300"></canvas>
        </div>
      </div>

      <!-- Histórico de Simulações -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mt-6">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">
          Histórico de Simulações
        </h2>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-3 text-left">Data</th>
                <th class="p-3 text-left">Sistema</th>
                <th class="p-3 text-left">Valor</th>
                <th class="p-3 text-left">Prestação</th>
                <th class="p-3 text-left">Ações</th>
              </tr>
            </thead>
            <tbody id="historicoSimulacoes">
              <!-- Preenchido pelo JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Botões de exportação -->
      <div class="mt-6 flex flex-wrap gap-4 justify-center">
        <button
          onclick="exportarPDF()"
          class="bg-red-500 hover:bg-red-600 text-white py-2 px-6 rounded-lg flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"
            />
          </svg>
          Exportar PDF
        </button>
        <button
          onclick="exportarCSV()"
          class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
            />
          </svg>
          Exportar CSV
        </button>
        <button
          onclick="copiarTabela()"
          class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
            />
          </svg>
          Copiar Tabela
        </button>
      </div>

      <footer
        class="text-center mt-8 py-4 text-gray-600 dark:text-gray-400 text-sm"
      >
        Simulador Financeiro &copy; 2023 - Desenvolvido para fins educacionais
      </footer>
    </div>

    <script>
      // Variáveis globais para os gráficos
      let graficoParcelas, graficoComposicao;

      // Mostrar/ocultar campo FGTS
      document
        .getElementById("usarFGTS")
        .addEventListener("change", function () {
          document
            .getElementById("fgtsContainer")
            .classList.toggle("hidden", !this.checked);
        });

      // Funções de cálculo
      function calcularPrice(valor, taxa, meses) {
        const prestacao = (valor * taxa) / (1 - Math.pow(1 + taxa, -meses));
        let saldo = valor;
        let jurosTotal = 0;
        const tabela = [];

        for (let i = 1; i <= meses; i++) {
          const juros = saldo * taxa;
          const amortizacao = prestacao - juros;
          saldo -= amortizacao;
          jurosTotal += juros;

          tabela.push({
            mes: i,
            prestacao,
            juros,
            amortizacao,
            saldo: saldo > 0 ? saldo : 0, // Evitar saldo negativo
          });
        }

        return {
          prestacao,
          jurosTotal,
          totalPago: valor + jurosTotal,
          tabela,
        };
      }

      function calcularSAC(valor, taxa, meses) {
        const amortizacaoMensal = valor / meses;
        let saldo = valor;
        let jurosTotal = 0;
        const tabela = [];

        for (let i = 1; i <= meses; i++) {
          const juros = saldo * taxa;
          const prestacao = amortizacaoMensal + juros;
          saldo -= amortizacaoMensal;
          jurosTotal += juros;

          tabela.push({
            mes: i,
            prestacao,
            juros,
            amortizacao: amortizacaoMensal,
            saldo: saldo > 0 ? saldo : 0, // Evitar saldo negativo
          });
        }

        return {
          primeiraPrestacao: tabela[0].prestacao,
          ultimaPrestacao: tabela[meses - 1].prestacao,
          jurosTotal,
          totalPago: valor + jurosTotal,
          tabela,
        };
      }

      function calcularCET(valorFinanciado, totalPago, meses) {
        // Cálculo simplificado do CET (para um cálculo preciso seria necessário um método iterativo)
        return (Math.pow(totalPago / valorFinanciado, 1 / meses) - 1) * 100;
      }

      function exibirResumo(resultado, valorImovel, entrada, sistema) {
        const resumoDiv = document.getElementById("resumo");

        let resumoHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span>Valor do Imóvel:</span>
                        <span class="font-medium">R$ ${valorImovel.toFixed(
                          2
                        )}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Valor da Entrada:</span>
                        <span class="font-medium">R$ ${entrada.toFixed(
                          2
                        )}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Valor Financiado:</span>
                        <span class="font-medium">R$ ${(
                          valorImovel - entrada
                        ).toFixed(2)}</span>
                    </div>
                    <div class="border-t pt-2 mt-2"></div>
            `;

        if (sistema === "price") {
          resumoHTML += `
                    <div class="flex justify-between">
                        <span>Prestação Fixa:</span>
                        <span class="font-medium">R$ ${resultado.prestacao.toFixed(
                          2
                        )}</span>
                    </div>
                `;
        } else {
          resumoHTML += `
                    <div class="flex justify-between">
                        <span>1ª Prestação:</span>
                        <span class="font-medium">R$ ${resultado.primeiraPrestacao.toFixed(
                          2
                        )}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Última Prestação:</span>
                        <span class="font-medium">R$ ${resultado.ultimaPrestacao.toFixed(
                          2
                        )}</span>
                    </div>
                `;
        }

        resumoHTML += `
                    <div class="flex justify-between">
                        <span>Total de Juros:</span>
                        <span class="font-medium">R$ ${resultado.jurosTotal.toFixed(
                          2
                        )}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total Pago:</span>
                        <span>R$ ${resultado.totalPago.toFixed(2)}</span>
                    </div>
                    <div class="border-t pt-2 mt-2"></div>
                    <div class="flex justify-between">
                        <span>CET (Custo Efetivo Total):</span>
                        <span class="font-medium">${calcularCET(
                          valorImovel - entrada,
                          resultado.totalPago,
                          document.getElementById("meses").value
                        ).toFixed(2)}% a.m.</span>
                    </div>
                </div>
            `;

        resumoDiv.innerHTML = resumoHTML;
      }

      function exibirTabela(tabela) {
        const corpoTabela = document.getElementById("corpoTabela");
        corpoTabela.innerHTML = "";

        // Mostrar apenas os primeiros 12 meses e os últimos 3 meses
        const mesesExibir = [...tabela.slice(0, 12)];

        if (tabela.length > 15) {
          mesesExibir.push({
            mes: "...",
            prestacao: "...",
            juros: "...",
            amortizacao: "...",
            saldo: "...",
          });
          mesesExibir.push(...tabela.slice(-3));
        } else if (tabela.length > 12) {
          mesesExibir.push(...tabela.slice(12));
        }

        mesesExibir.forEach((item) => {
          const row = document.createElement("tr");
          row.className = "border-b hover:bg-gray-50 dark:hover:bg-gray-700";
          row.innerHTML = `
                    <td class="p-3">${item.mes}</td>
                    <td class="p-3">R$ ${
                      typeof item.prestacao === "number"
                        ? item.prestacao.toFixed(2)
                        : item.prestacao
                    }</td>
                    <td class="p-3">R$ ${
                      typeof item.juros === "number"
                        ? item.juros.toFixed(2)
                        : item.juros
                    }</td>
                    <td class="p-3">R$ ${
                      typeof item.amortizacao === "number"
                        ? item.amortizacao.toFixed(2)
                        : item.amortizacao
                    }</td>
                    <td class="p-3">R$ ${
                      typeof item.saldo === "number"
                        ? item.saldo.toFixed(2)
                        : item.saldo
                    }</td>
                `;
          corpoTabela.appendChild(row);
        });
      }

      function atualizarGraficos(tabela, sistema) {
        const ctxParcelas = document
          .getElementById("graficoParcelas")
          .getContext("2d");
        const ctxComposicao = document
          .getElementById("graficoComposicao")
          .getContext("2d");

        // Destruir gráficos anteriores se existirem
        if (graficoParcelas) graficoParcelas.destroy();
        if (graficoComposicao) graficoComposicao.destroy();

        // Preparar dados para os gráficos
        const labels = tabela.map((item) => item.mes);
        const prestacoes = tabela.map((item) => item.prestacao);
        const juros = tabela.map((item) => item.juros);
        const amortizacoes = tabela.map((item) => item.amortizacao);
        const saldos = tabela.map((item) => item.saldo);

        // Gráfico de parcelas
        graficoParcelas = new Chart(ctxParcelas, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Prestação",
                data: prestacoes,
                borderColor: "#3B82F6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                tension: sistema === "price" ? 0 : 0.4,
              },
              {
                label: "Juros",
                data: juros,
                borderColor: "#EF4444",
                backgroundColor: "rgba(239, 68, 68, 0.1)",
                tension: 0.4,
              },
              {
                label: "Amortização",
                data: amortizacoes,
                borderColor: "#10B981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                tension: sistema === "price" ? 0.4 : 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Evolução das Parcelas",
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: R$ ${context.raw.toFixed(
                      2
                    )}`;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "R$ " + value.toFixed(2);
                  },
                },
              },
            },
          },
        });

        // Gráfico de composição
        const totalJuros = tabela.reduce((sum, item) => sum + item.juros, 0);
        const totalAmortizacao = tabela.reduce(
          (sum, item) => sum + item.amortizacao,
          0
        );

        graficoComposicao = new Chart(ctxComposicao, {
          type: "doughnut",
          data: {
            labels: ["Juros", "Amortização"],
            datasets: [
              {
                data: [totalJuros, totalAmortizacao],
                backgroundColor: ["#EF4444", "#10B981"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Composição do Financiamento",
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage = Math.round((value / total) * 100);
                    return `${context.label}: R$ ${value.toFixed(
                      2
                    )} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      function simularAntecipacao() {
        const percent =
          parseFloat(document.getElementById("percentAntecipacao").value) / 100;
        const mes = parseInt(document.getElementById("mesAntecipacao").value);
        const sistema = document.getElementById("sistema").value;

        if (!percent || !mes) {
          alert("Preencha todos os campos para simular a antecipação");
          return;
        }

        // Obter a simulação atual
        const valorImovel = parseFloat(
          document.getElementById("valorImovel").value
        );
        const entrada =
          parseFloat(document.getElementById("entrada").value) || 0;
        const taxa = parseFloat(document.getElementById("taxa").value) / 100;
        const meses = parseInt(document.getElementById("meses").value);

        let resultado;
        if (sistema === "price") {
          resultado = calcularPrice(valorImovel - entrada, taxa, meses);
        } else {
          resultado = calcularSAC(valorImovel - entrada, taxa, meses);
        }

        // Encontrar o saldo no mês escolhido
        const saldoNoMes = resultado.tabela[mes - 1].saldo;
        const valorAntecipacao = saldoNoMes * percent;

        // Calcular nova simulação com antecipação
        const novoSaldo = saldoNoMes - valorAntecipacao;

        let novaSimulacao;
        if (sistema === "price") {
          novaSimulacao = calcularPrice(novoSaldo, taxa, meses - mes);
        } else {
          novaSimulacao = calcularSAC(novoSaldo, taxa, meses - mes);
        }

        // Exibir resultados
        const resultadoDiv = document.getElementById("resultadoAntecipacao");
        const detalhesDiv = document.getElementById("detalhesAntecipacao");

        detalhesDiv.innerHTML = `
                <p><strong>Valor Antecipado:</strong> R$ ${valorAntecipacao.toFixed(
                  2
                )}</p>
                <p><strong>Saldo Devedor após Antecipação:</strong> R$ ${novoSaldo.toFixed(
                  2
                )}</p>
                <p><strong>Novo Prazo:</strong> ${meses - mes} meses</p>
                <p><strong>Economia de Juros:</strong> R$ ${(
                  resultado.jurosTotal - novaSimulacao.jurosTotal
                ).toFixed(2)}</p>
            `;

        resultadoDiv.classList.remove("hidden");
      }

      function calcular() {
        // Obter valores dos inputs
        const valorImovel = parseFloat(
          document.getElementById("valorImovel").value
        );
        const entrada =
          parseFloat(document.getElementById("entrada").value) || 0;
        const taxa = parseFloat(document.getElementById("taxa").value) / 100;
        const meses = parseInt(document.getElementById("meses").value);
        const sistema = document.getElementById("sistema").value;

        // Validar entradas
        if (!valorImovel || isNaN(taxa)) {
          alert("Por favor, preencha todos os campos obrigatórios!");
          return;
        }

        const valorFinanciado = valorImovel - entrada;

        // Adicionar cálculo de seguros e taxas
        const seguroMIP =
          parseFloat(document.getElementById("seguroMIP").value) / 100 / 12;
        const seguroDFI =
          parseFloat(document.getElementById("seguroDFI").value) / 100 / 12;
        const taxaAdm = parseFloat(document.getElementById("taxaAdm").value);
        const usarFGTS = document.getElementById("usarFGTS").checked;
        const saldoFGTS = usarFGTS
          ? parseFloat(document.getElementById("saldoFGTS").value)
          : 0;

        let resultado;
        // Ajustar cálculo para incluir encargos
        if (sistema === "price") {
          resultado = calcularPrice(
            valorFinanciado,
            taxa + seguroMIP + seguroDFI,
            meses
          );
          // Adicionar taxa administrativa à prestação
          resultado.prestacao += taxaAdm;
          resultado.tabela.forEach((item) => {
            item.prestacao += taxaAdm;
          });
        } else {
          resultado = calcularSAC(
            valorFinanciado,
            taxa + seguroMIP + seguroDFI,
            meses
          );
          // Adicionar taxa administrativa à prestação
          resultado.primeiraPrestacao += taxaAdm;
          resultado.ultimaPrestacao += taxaAdm;
          resultado.tabela.forEach((item) => {
            item.prestacao += taxaAdm;
          });
        }

        // Aplicar FGTS se selecionado
        if (usarFGTS && saldoFGTS > 0) {
          const amortizacaoFGTS = Math.min(saldoFGTS, valorFinanciado * 0.8); // Limite de 80% do valor financiado
          const novoValorFinanciado = valorFinanciado - amortizacaoFGTS;

          // Recalcular com novo valor financiado
          if (sistema === "price") {
            resultado = calcularPrice(
              novoValorFinanciado,
              taxa + seguroMIP + seguroDFI,
              meses
            );
            resultado.prestacao += taxaAdm;
          } else {
            resultado = calcularSAC(
              novoValorFinanciado,
              taxa + seguroMIP + seguroDFI,
              meses
            );
            resultado.primeiraPrestacao += taxaAdm;
            resultado.ultimaPrestacao += taxaAdm;
          }

          resultado.totalPago += amortizacaoFGTS; // Adiciona o FGTS ao total pago
          resultado.tabela.forEach((item) => {
            item.prestacao += taxaAdm;
          });
        }

        // Exibir resultados
        exibirResumo(resultado, valorImovel, entrada, sistema);
        exibirTabela(resultado.tabela);
        atualizarGraficos(resultado.tabela, sistema);

        // Salvar no histórico
        salvarNoHistorico(resultado, sistema, valorImovel, entrada);
      }

      // Gerenciamento do histórico
      function salvarNoHistorico(resultado, sistema, valorImovel, entrada) {
        let historico =
          JSON.parse(localStorage.getItem("historicoSimulacoes")) || [];

        historico.unshift({
          data: new Date().toLocaleString(),
          sistema,
          valorImovel,
          entrada,
          prestacao:
            sistema === "price"
              ? resultado.prestacao
              : resultado.primeiraPrestacao,
          dados: resultado,
        });

        // Manter apenas as últimas 5 simulações
        historico = historico.slice(0, 5);

        localStorage.setItem("historicoSimulacoes", JSON.stringify(historico));
        atualizarHistoricoUI();
      }

      function atualizarHistoricoUI() {
        const historico =
          JSON.parse(localStorage.getItem("historicoSimulacoes")) || [];
        const tbody = document.getElementById("historicoSimulacoes");

        tbody.innerHTML = historico
          .map(
            (item) => `
                <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="p-3">${item.data}</td>
                    <td class="p-3">${
                      item.sistema === "price" ? "PRICE" : "SAC"
                    }</td>
                    <td class="p-3">R$ ${parseFloat(item.valorImovel).toFixed(
                      2
                    )}</td>
                    <td class="p-3">R$ ${item.prestacao.toFixed(2)}</td>
                    <td class="p-3">
                        <button onclick="carregarSimulacao(${historico.indexOf(
                          item
                        )})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                            Recarregar
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function carregarSimulacao(index) {
        const historico =
          JSON.parse(localStorage.getItem("historicoSimulacoes")) || [];
        const simulacao = historico[index];

        if (simulacao) {
          document.getElementById("valorImovel").value = simulacao.valorImovel;
          document.getElementById("entrada").value = simulacao.entrada;
          document.getElementById("sistema").value = simulacao.sistema;

          // Atualizar UI e recalcular
          calcular();
        }
      }

      function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Título
        doc.setFontSize(18);
        doc.text("Relatório de Simulação Financeira", 105, 15, {
          align: "center",
        });

        // Data
        doc.setFontSize(10);
        doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, 105, 22, {
          align: "center",
        });

        // Resumo
        doc.setFontSize(12);
        const resumoLines = document
          .getElementById("resumo")
          .textContent.split("\n")
          .filter((line) => line.trim());
        let y = 40;
        resumoLines.forEach((line) => {
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          doc.text(line.trim(), 14, y);
          y += 7;
        });

        // Tabela (apenas primeiras linhas)
        doc.autoTable({
          html: "#tabelaResultados",
          startY: y + 10,
          margin: { top: 20 },
          headStyles: { fillColor: [59, 130, 246] },
          styles: { fontSize: 8 },
        });

        doc.save("simulacao_financeira.pdf");
      }

      function exportarCSV() {
        const sistema = document.getElementById("sistema").value;
        const valorImovel = document.getElementById("valorImovel").value;
        const taxa = document.getElementById("taxa").value;
        const meses = document.getElementById("meses").value;

        let csv = "Simulação Financeira\n\n";
        csv += `Sistema: ${sistema === "price" ? "PRICE" : "SAC"}\n`;
        csv += `Valor do Imóvel: R$ ${parseFloat(valorImovel).toFixed(2)}\n`;
        csv += `Taxa de Juros: ${taxa}% a.m.\n`;
        csv += `Prazo: ${meses} meses\n\n`;

        // Adicionar resumo
        const resumoLines = document
          .getElementById("resumo")
          .textContent.split("\n")
          .filter((line) => line.trim());
        resumoLines.forEach((line) => {
          csv += line.trim() + "\n";
        });

        csv += "\nTabela de Amortização\n";
        csv += "Mês,Prestação,Juros,Amortização,Saldo Devedor\n";

        // Adicionar dados da tabela
        const rows = document.querySelectorAll("#tabelaResultados tbody tr");
        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          csv += `${cells[0].textContent},${cells[1].textContent.replace(
            "R$ ",
            ""
          )},${cells[2].textContent.replace(
            "R$ ",
            ""
          )},${cells[3].textContent.replace(
            "R$ ",
            ""
          )},${cells[4].textContent.replace("R$ ", "")}\n`;
        });

        // Criar e baixar o arquivo
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "simulacao_financeira.csv";
        link.click();
      }

      function copiarTabela() {
        const range = document.createRange();
        range.selectNode(document.getElementById("tabelaResultados"));
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
        window.getSelection().removeAllRanges();

        // Feedback visual
        const botao = document.querySelector(
          'button[onclick="copiarTabela()"]'
        );
        const originalText = botao.textContent;
        botao.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Tabela copiada!';

        setTimeout(() => {
          botao.textContent = originalText;
        }, 2000);
      }

      // Inicialização
      document.addEventListener("DOMContentLoaded", function () {
        // Adicionar máscara de valores monetários
        document
          .getElementById("valorImovel")
          .addEventListener("blur", function () {
            this.value = parseFloat(this.value || 0).toFixed(2);
          });

        document
          .getElementById("entrada")
          .addEventListener("blur", function () {
            this.value = parseFloat(this.value || 0).toFixed(2);
          });

        // Carregar histórico
        atualizarHistoricoUI();
      });
    </script>
  </body>
</html>
